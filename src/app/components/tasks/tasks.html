<div class="tasks-container" dir="rtl">
  <div class="header-section">
    <div class="page-title">
      <a class="back-link" [routerLink]="['/teams', 1, 'projects']">
        â†’ ×—×–×¨×” ×œ×¤×¨×•×™×§×˜×™×
      </a>
      <h2>{{ getProjectName() }}</h2>
    </div>
    <button class="add-task-btn" (click)="showForm.set(!showForm())">
      <span class="btn-icon">+</span>
      <span>××©×™××” ×—×“×©×”</span>
    </button>
  </div>

  @if (showForm()) {
    <div class="add-task-modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3>××©×™××” ×—×“×©×”</h3>
          <button class="close-btn" (click)="showForm.set(false)">Ã—</button>
        </div>
        
        <div class="modal-body">
          <div class="form-group">
            <label>×›×•×ª×¨×ª ×”××©×™××”</label>
            <input 
              [(ngModel)]="newTask.title" 
              type="text" 
              placeholder="××” ×¦×¨×™×š ×œ×‘×¦×¢?"
              class="form-input"
              name="taskTitle"> 
          </div>

          <div class="form-group">
            <label>×ª×™××•×¨ ×”××©×™××”</label>
            <textarea 
              [(ngModel)]="newTask.description" 
              placeholder="×”×•×¡×™×¤×™ ×¤×™×¨×•×˜..."
              class="form-textarea"
              rows="3"></textarea>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>×¢×“×™×¤×•×ª</label>
              <select [(ngModel)]="newTask.priority" class="form-select">
                <option value="low">× ××•×›×”</option>
                <option value="normal">×¨×’×™×œ×”</option>
                <option value="high">×’×‘×•×”×”</option>
              </select>
            </div>

            <div class="form-group">
              <label>×ª××¨×™×š ×™×¢×“</label>
              <input 
                [(ngModel)]="newTask.dueDate" 
                type="date" 
                class="form-input">
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button class="btn-cancel" (click)="showForm.set(false)">×‘×™×˜×•×œ</button>
          <button class="btn-save" (click)="addTask()">×©××•×¨ ××©×™××”</button>
        </div>
      </div>
    </div>
  }

  @if (isLoading()) {
    <div class="loading">×˜×•×¢×Ÿ ××©×™××•×ª...</div>
  }

  <div class="kanban-board">
    <div class="kanban-column">
      <div class="column-header backlog">
        <h3>×œ×‘×™×¦×•×¢</h3>
        <span class="task-count">{{ getTasksByStatus('todo').length }}</span>
      </div>
      <div class="column-content">
        @for (task of getTasksByStatus('todo'); track task.id) {
          <div class="task-card">
            <div class="task-header">
              <h4>{{ task.title }}</h4>
              <button class="delete-btn" (click)="removeTask(task.id!)">Ã—</button>
            </div>
            
            <p class="task-description">{{ task.description }}</p>
            
            <div class="task-footer">
              <span class="priority-badge" [class]="'priority-' + task.priority">
                {{ getPriorityLabel(task.priority) }}
              </span>
              
              @if (task.due_date) {
                <span class="due-date">ğŸ“… {{ task.due_date | date:'dd/MM' }}</span>
              }
            </div>

            <div class="task-actions">
              <button 
                class="action-btn move-right" 
                (click)="changeStatus(task.id!, 'in_progress')">
                â† ×‘×ª×”×œ×™×š
              </button>
              <button 
                class="action-btn comments" 
                (click)="toggleComments(task.id!)">
                ğŸ’¬ {{ activeTaskId() === task.id ? commentsCount() : '×ª×’×•×‘×•×ª' }}
              </button>
            </div>

            @if (activeTaskId() === task.id) {
              <div class="comments-section">
                <div class="comments-list">
                  @for (comment of currentComments(); track comment.id) {
                    <div class="comment-item">
                      <div class="comment-header">
                        <strong>{{ getCommentUserName(comment) }}</strong>
                        <span class="separator">â€¢</span>
                        <small>{{ comment.created_at | date:'dd/MM/yyyy HH:mm' }}</small>
                      </div>
                      <div class="comment-body">{{ comment.body }}</div>
                    </div>
                  } @empty {
                    <p class="no-comments">××™×Ÿ ×ª×’×•×‘×•×ª</p>
                  }
                </div>
                
                <div class="add-comment">
                  <input 
                    #commentInput 
                    type="text" 
                    placeholder="×”×•×¡×£ ×ª×’×•×‘×”..."
                    (keyup.enter)="addComment(task.id!, commentInput.value); commentInput.value = ''">
                  <button (click)="addComment(task.id!, commentInput.value); commentInput.value = ''">
                    ×©×œ×—
                  </button>
                </div>
              </div>
            }
          </div>
        } @empty {
          <div class="empty-column">××™×Ÿ ××©×™××•×ª</div>
        }
      </div>
    </div>

    <div class="kanban-column">
      <div class="column-header in-progress">
        <h3>×‘×ª×”×œ×™×š</h3>
        <span class="task-count">{{ getTasksByStatus('in_progress').length }}</span>
      </div>
      <div class="column-content">
        @for (task of getTasksByStatus('in_progress'); track task.id) {
          <div class="task-card">
            <div class="task-header">
              <h4>{{ task.title }}</h4>
              <button class="delete-btn" (click)="removeTask(task.id!)">Ã—</button>
            </div>
            
            <p class="task-description">{{ task.description }}</p>
            
            <div class="task-footer">
              <span class="priority-badge" [class]="'priority-' + task.priority">
                {{ getPriorityLabel(task.priority) }}
              </span>
              
              @if (task.due_date) {
                <span class="due-date">ğŸ“… {{ task.due_date | date:'dd/MM' }}</span>
              }
            </div>

            <div class="task-actions">
              <button 
                class="action-btn move-left" 
                (click)="changeStatus(task.id!, 'todo')">
                â† ×œ×‘×™×¦×•×¢
              </button>
              <button 
                class="action-btn move-right" 
                (click)="changeStatus(task.id!, 'done')">
                ×”×•×©×œ× â†’
              </button>
              <button 
                class="action-btn comments" 
                (click)="toggleComments(task.id!)">
                ğŸ’¬ {{ activeTaskId() === task.id ? commentsCount() : '×ª×’×•×‘×•×ª' }}
              </button>
            </div>

            @if (activeTaskId() === task.id) {
              <div class="comments-section">
                <div class="comments-list">
                  @for (comment of currentComments(); track comment.id) {
                    <div class="comment-item">
                      <div class="comment-header">
                        <strong>{{ getCommentUserName(comment) }}</strong>
                        <span class="separator">â€¢</span>
                        <small>{{ comment.created_at | date:'dd/MM/yyyy HH:mm' }}</small>
                      </div>
                      <div class="comment-body">{{ comment.body }}</div>
                    </div>
                  } @empty {
                    <p class="no-comments">××™×Ÿ ×ª×’×•×‘×•×ª</p>
                  }
                </div>
                
                <div class="add-comment">
                  <input 
                    #commentInput 
                    type="text" 
                    placeholder="×”×•×¡×£ ×ª×’×•×‘×”..."
                    (keyup.enter)="addComment(task.id!, commentInput.value); commentInput.value = ''">
                  <button (click)="addComment(task.id!, commentInput.value); commentInput.value = ''">
                    ×©×œ×—
                  </button>
                </div>
              </div>
            }
          </div>
        } @empty {
          <div class="empty-column">××™×Ÿ ××©×™××•×ª</div>
        }
      </div>
    </div>

    <div class="kanban-column">
      <div class="column-header done">
        <h3>×‘×•×¦×¢</h3>
        <span class="task-count">{{ getTasksByStatus('done').length }}</span>
      </div>
      <div class="column-content">
        @for (task of getTasksByStatus('done'); track task.id) {
          <div class="task-card completed">
            <div class="task-header">
              <h4>{{ task.title }}</h4>
              <button class="delete-btn" (click)="removeTask(task.id!)">Ã—</button>
            </div>
            
            <p class="task-description">{{ task.description }}</p>
            
            <div class="task-footer">
              <span class="priority-badge" [class]="'priority-' + task.priority">
                {{ getPriorityLabel(task.priority) }}
              </span>
              
              @if (task.due_date) {
                <span class="due-date">ğŸ“… {{ task.due_date | date:'dd/MM' }}</span>
              }
            </div>

            <div class="task-actions">
              <button 
                class="action-btn move-left" 
                (click)="changeStatus(task.id!, 'in_progress')">
                â† ×‘×ª×”×œ×™×š
              </button>
              <button 
                class="action-btn comments" 
                (click)="toggleComments(task.id!)">
                ğŸ’¬ {{ activeTaskId() === task.id ? commentsCount() : '×ª×’×•×‘×•×ª' }}
              </button>
            </div>

            @if (activeTaskId() === task.id) {
              <div class="comments-section">
                <div class="comments-list">
                  @for (comment of currentComments(); track comment.id) {
                    <div class="comment-item">
                      <div class="comment-header">
                        <strong>{{ getCommentUserName(comment) }}</strong>
                        <span class="separator">â€¢</span>
                        <small>{{ comment.created_at | date:'dd/MM/yyyy HH:mm' }}</small>
                      </div>
                      <div class="comment-body">{{ comment.body }}</div>
                    </div>
                  } @empty {
                    <p class="no-comments">××™×Ÿ ×ª×’×•×‘×•×ª</p>
                  }
                </div>
                
                <div class="add-comment">
                  <input 
                    #commentInput 
                    type="text" 
                    placeholder="×”×•×¡×£ ×ª×’×•×‘×”..."
                    (keyup.enter)="addComment(task.id!, commentInput.value); commentInput.value = ''">
                  <button (click)="addComment(task.id!, commentInput.value); commentInput.value = ''">
                    ×©×œ×—
                  </button>
                </div>
              </div>
            }
          </div>
        } @empty {
          <div class="empty-column">××™×Ÿ ××©×™××•×ª</div>
        }
      </div>
    </div>
  </div>
</div>